<?php
include 'db.php';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $username = $_POST['username'];
    $email = $_POST['email'];

    // Sanitasi input untuk keamanan
    $username = pg_escape_string($conn, $username);
    $email = pg_escape_string($conn, $email);

    // Semak jika emel sudah wujud
    $checkEmailQuery = "SELECT * FROM edim_user WHERE email = $1";
    $checkResult = pg_query_params($conn, $checkEmailQuery, array($email));

    if (pg_num_rows($checkResult) > 0) {
        // Jika emel sudah wujud, return "email_exists"
        echo "email_exists";
        exit;
    } else {
        // Prepare query untuk masukkan data
        $result = pg_prepare($conn, "insert_contact", 
            "INSERT INTO edim_user (username, email) VALUES ($1, $2)"
        );

        if ($result) {
            $exec = pg_execute($conn, "insert_contact", array($username, $email));
            if ($exec) {
                // Jika berjaya, beri respons success
                echo "success";
            } else {
                // Jika ada ralat semasa simpan
                echo "error";
            }
        } else {
            // Jika failed untuk prepare statement
            echo "error";
        }
    }

    pg_close($conn);
}
?>
